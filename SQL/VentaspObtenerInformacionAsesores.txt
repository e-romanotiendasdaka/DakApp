USE [master]
GO
/****** Object:  StoredProcedure [dbo].[VentaspObtenerInformacionAsesores]    Script Date: 02/11/2023 12:16:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Romano,Elvis>
-- Create date: <2023-11-01>
-- Description:	<Obtener Asesores de Ventas>
-- =============================================
CREATE OR ALTER PROCEDURE [dbo].[VentaspObtenerInformacionAsesores]
AS
BEGIN

SET NOCOUNT ON;
DECLARE @TotalSalesLogs TABLE (IdRegistro INT IDENTITY(1,1),IdLogIntegracion INT,Data NVARCHAR(max))
DECLARE @VendorsData TABLE (IdRegistro INT IDENTITY(1,1),IdAsesor VARCHAR(MAX))
DECLARE @VendorsData2 TABLE(IdRegistro int identity(1,1),IdAsesor varchar(MAX) COLLATE SQL_Latin1_General_CP1_CI_AS)
INSERT INTO @TotalSalesLogs
SELECT ls.IdLogIntegracion,ls.Data 
FROM POS_MDW.Integracion.LogIntegraciones ls WITH(nolock) 
WHERE ls.IdTipoLog = 1 				
AND ls.IdCaja <> ISNULL((SELECT ISNULL(C.IdCaja, 0) FROM ERP_POS_CENTRAL.ConfiguracionPOS.Cajas C WITH(NOLOCK) WHERE C.SerialImpresora = 'CAJAKLK'), 0)

;WITH CteFacturas AS(
	SELECT A.IdLogIntegracion,B.DetalleFacturas
	FROM @TotalSalesLogs A
	CROSS APPLY ( SELECT * FROM OPENJSON(Data) WITH (DetalleFacturas nvarchar(MAX) '$.DetalleFacturas' AS JSON)) B
)
INSERT INTO @VendorsData([IdAsesor])
SELECT STRING_AGG(CONVERT(NVARCHAR(MAX),ISNULL(B.IdAsesor,-1)),',' )
FROM CteFacturas A
CROSS APPLY ( SELECT * FROM OPENJSON(DetalleFacturas) WITH (IdAsesor bigint)) B

INSERT INTO @VendorsData2
SELECT DISTINCT VALUE FROM @VendorsData CROSS APPLY STRING_SPLIT(IdAsesor, ','); 

(SELECT UPPER(e.Nombre) + ' ' + UPPER(e.Apellido) AS Nombre,e.NumeroDocumento AS Cedula,u.IdUsuario AS IdAsesor,
		e.NumeroDocumento + ' - ' + UPPER(e.Nombre) + ' ' + UPPER(e.Apellido) AS DataAsesor
FROM ERP.Maestro.Entidades e
INNER JOIN ERP.Seguridad.Usuarios u ON e.IdEntidad = u.IdEntidad
INNER JOIN (SELECT DISTINCT IdAsesor FROM @VendorsData2) a ON u.IdUsuario = a.IdAsesor
WHERE u.IndActivo = 1 AND (u.ClaveExterna != '' OR (u.IdUsuario NOT IN (0,1)))	)
UNION ALL
(SELECT  'SIN ASESOR ASIGNADO' AS Nombre,'N/A' AS Cedula,-1,'N/A' + ' - ' + 'SIN ASESOR ASIGNADO' AS DataAsesor) ORDER BY Cedula
FOR JSON PATH
END
